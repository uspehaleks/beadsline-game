# Настройка базы данных для проекта BeadsLine

В этом документе описан процесс настройки подключения к базе данных для проекта BeadsLine, работающего на Next.js с использованием Drizzle ORM и PostgreSQL.

## Требования

- PostgreSQL 12 или выше
- Учетная запись на Vercel (для деплоя)
- Установленный Node.js 20.x

## Конфигурация переменных окружения

Создайте или обновите файл `.env.local` в корне проекта:

```bash
# Подключение к базе данных PostgreSQL
DATABASE_URL="postgresql://username:password@host:port/database_name?sslmode=require"

# Прямое подключение (обычно такое же, как DATABASE_URL)
DIRECT_URL="postgresql://username:password@host:port/database_name?sslmode=require"

# Секрет для сессий
SESSION_SECRET="ваш-секретный-ключ-минимум-32-символа-для-шифрования-сеансов"

# Режим окружения
NODE_ENV="development" # или "production" для продакшена
```

## Настройка PostgreSQL

### Вариант 1: Использование Supabase (рекомендуется для разработки)

1. Зарегистрируйтесь на [supabase.com](https://supabase.com)
2. Создайте новый проект
3. Найдите строку подключения в разделе Project Settings → Database
4. Скопируйте строку подключения и используйте её в `DATABASE_URL`

### Вариант 2: Использование другого хостинга PostgreSQL

1. Получите строку подключения от вашего провайдера
2. Убедитесь, что она включает SSL режим (`sslmode=require`)
3. Используйте её в `DATABASE_URL`

## Миграции базы данных

Для запуска миграций используйте команду:

```bash
npm run db:migrate
```

Это применит все незафиксированные миграции к вашей базе данных.

## Структура подключения

Проект использует следующие файлы для управления подключением к базе данных:

- `server/db.ts` - основной файл конфигурации подключения
- `shared/schema.ts` - определение схемы базы данных
- `drizzle.config.ts` - конфигурация Drizzle Kit
- `migrations/` - SQL файлы миграций

## Особенности для Vercel

Подключение к базе данных настроено с учетом особенностей serverless среды Vercel:

- Используется минимальный пул соединений
- Установлены короткие таймауты
- Для каждого запроса создается временное соединение
- SSL режим принудительно включен

## Проверка подключения

Вы можете проверить подключение к базе данных, вызвав API маршрут:

```
GET /api/db-health
```

Этот маршрут возвращает статус подключения к базе данных.

## Возможные проблемы и решения

### Ошибка "no pg_hba.conf entry for host"

Это означает, что ваш хост базы данных не разрешает подключения из текущего IP. Убедитесь, что ваш провайдер базы данных позволяет внешние подключения.

### Ошибка SSL

Убедитесь, что в строке подключения указан параметр `sslmode=require`.

### Ошибка "Connection timed out"

Проверьте настройки firewall и убедитесь, что порт 5432 открыт для подключения.

## Дополнительная информация

Для получения дополнительной информации о Drizzle ORM посетите [официальную документацию](https://orm.drizzle.team).

Для вопросов, связанных с PostgreSQL, обратитесь к [официальной документации PostgreSQL](https://www.postgresql.org/docs/).